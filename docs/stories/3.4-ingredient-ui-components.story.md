# Story 3.4: Create Ingredient Management UI Components

## Status
Ready for Development

## Story
**As a** user,
**I want** dedicated UI components for managing ingredients directly,
**So that** I can edit ingredient content without dealing with config format transformations

## Acceptance Criteria
1. IngredientList component showing all available ingredients
2. IngredientEditor for direct section/test editing
3. Visual indicators for shared/unique/modified ingredients
4. Search and filter capabilities
5. Integration with existing CodeMirror editor
6. Clean, intuitive design that meets accessibility standards

## TDD Approach with Playwright Testing
**Following TDD Agentic Workflow with UI Testing:**
1. **Write Tests First** - Component tests AND Playwright E2E tests for UI/UX
2. **Make It Green** - Build components to pass tests
3. **Refactor** - Improve design and accessibility
4. **Visual Validation** - Use Playwright to screenshot and verify design

## Tasks / Subtasks

### Task 0: Write Component and E2E Tests FIRST (TDD Step 1)
- [ ] Create component test file `src/lib/components/__tests__/IngredientList.test.ts`
  ```typescript
  describe('IngredientList Component', () => {
    it('should render ingredients with visual indicators', () => {
      const ingredients = [mockSharedIngredient(), mockUniqueIngredient()];
      const { getByText, getByTestId } = render(IngredientList, { ingredients });
      expect(getByTestId('badge-shared')).toBeVisible();
      expect(getByTestId('badge-unique')).toBeVisible();
    });
  });
  ```
- [ ] Create Playwright E2E test `e2e/ingredient-ui.spec.ts`:
  ```typescript
  test('Ingredient UI Design and Accessibility', async ({ page }) => {
    await page.goto('/ingredients');
    
    // Take screenshot for design review
    await page.screenshot({ path: 'screenshots/ingredient-list.png', fullPage: true });
    
    // Check accessibility
    const accessibilitySnapshot = await page.accessibility.snapshot();
    expect(accessibilitySnapshot.violations).toHaveLength(0);
    
    // Test visual indicators
    const sharedBadge = page.locator('[data-testid="badge-shared"]');
    await expect(sharedBadge).toHaveCSS('background-color', 'rgb(34, 197, 94)'); // green
    
    // Test search functionality
    await page.fill('[placeholder="Search ingredients..."]', 'calcium');
    await expect(page.locator('.ingredient-item')).toHaveCount(1);
    
    // Verify console has no errors
    const consoleLogs = await page.evaluate(() => window.console.logs);
    expect(consoleLogs.filter(log => log.type === 'error')).toHaveLength(0);
  });
  ```
- [ ] Create visual regression tests for design consistency
- [ ] Run tests - all should fail (Red phase)

### Task 1: Create IngredientList Component (AC: 1, 3)
- [ ] Create new file `src/lib/components/IngredientList.svelte`
- [ ] Use Svelte 5 runes syntax ($state, $derived, $effect)
- [ ] Define props interface using TypeScript:
  ```typescript
  let { 
    ingredients = [],
    selectedIngredientId = null,
    onSelect = (ingredient: Ingredient) => {},
    onEdit = (ingredient: Ingredient) => {},
    onDelete = (ingredientId: string) => {}
  } = $props();
  ```
- [ ] Create list layout with visual hierarchy
- [ ] Add visual indicators:
  - [ ] ğŸ“¦ Icon for ingredients
  - [ ] Badge showing usage count (e.g., "Used by: 12")
  - [ ] Color coding: green (shared), blue (unique), orange (modified)
  - [ ] Category badges (Micronutrient, Additive, etc.)
- [ ] Implement click handlers for selection and editing
- [ ] Add hover states and active selection styling

### Task 2: Implement Search and Filter UI (AC: 4)
- [ ] Add search input with reactive filtering:
  ```typescript
  let searchQuery = $state('');
  let filteredIngredients = $derived(() => 
    ingredients.filter(ing => 
      ing.displayName.toLowerCase().includes(searchQuery.toLowerCase())
    )
  );
  ```
- [ ] Create category filter dropdown:
  - [ ] Extract unique categories from ingredients
  - [ ] Multi-select capability
  - [ ] Clear filters button
- [ ] Add population type filter (Neonatal, Pediatric, Adult)
- [ ] Implement sort options (name, usage, last modified)
- [ ] Add result count display

### Task 3: Create IngredientEditor Component (AC: 2, 5)
- [ ] Create new file `src/lib/components/IngredientEditor.svelte`
- [ ] Define props with TypeScript:
  ```typescript
  let {
    ingredient = null,
    onSave = (updated: Ingredient) => {},
    onCancel = () => {},
    readOnly = false
  } = $props();
  ```
- [ ] Create tabbed interface:
  - [ ] "Sections" tab for content editing
  - [ ] "Tests" tab for test case management
  - [ ] "Variants" tab for population-specific data
  - [ ] "Metadata" tab for properties
- [ ] Integrate existing CodeEditor component for sections:
  ```typescript
  <CodeEditor 
    value={section.content}
    language={section.type === 'dynamic' ? 'javascript' : 'html'}
    onChange={(newContent) => updateSection(section.id, newContent)}
  />
  ```
- [ ] Add section management controls:
  - [ ] Add new section button
  - [ ] Delete section with confirmation
  - [ ] Reorder sections (drag & drop or arrows)
  - [ ] Toggle section type (static/dynamic)

### Task 4: Create IngredientPanel Container (AC: 1, 2)
- [ ] Create new file `src/lib/components/IngredientPanel.svelte`
- [ ] Combine List and Editor in split-pane layout:
  ```typescript
  let showEditor = $state(false);
  let selectedIngredient = $state(null);
  let splitRatio = $state(30); // 30% list, 70% editor
  ```
- [ ] Add panel controls:
  - [ ] Toggle between list-only and split view
  - [ ] Adjustable splitter between list and editor
  - [ ] Full-screen editor mode
- [ ] Handle ingredient selection flow:
  - [ ] Select in list â†’ Load in editor
  - [ ] Edit â†’ Show save/cancel buttons
  - [ ] Save â†’ Update list display

### Task 5: Create Store for Ingredient State Management
- [ ] Create new file `src/lib/stores/ingredientStore.svelte.ts`
- [ ] Use Svelte 5 runes in .svelte.ts file:
  ```typescript
  class IngredientStore {
    private _ingredients = $state<Ingredient[]>([]);
    private _selectedId = $state<string | null>(null);
    private _loading = $state(false);
    
    get ingredients() { return this._ingredients; }
    get selectedIngredient() { 
      return $derived(() => 
        this._ingredients.find(i => i.id === this._selectedId)
      );
    }
    
    async loadIngredients() {
      this._loading = true;
      this._ingredients = await ingredientService.list();
      this._loading = false;
    }
    
    selectIngredient(id: string) {
      this._selectedId = id;
    }
  }
  
  export const ingredientStore = new IngredientStore();
  ```
- [ ] Add methods for CRUD operations
- [ ] Implement optimistic updates
- [ ] Add error handling state

### Task 6: Integrate with Existing UI (AC: 5, IV1, IV2, IV3)
- [ ] Add "Ingredients" tab to main navigation/sidebar
- [ ] Ensure existing Sidebar component continues working
- [ ] Apply consistent styling from existing components:
  - [ ] Use same color scheme and spacing
  - [ ] Match button styles from existing UI
  - [ ] Use same font (Fira Code for code, system font for UI)
- [ ] Add feature flag to show/hide ingredient UI:
  ```typescript
  const showIngredientUI = import.meta.env.VITE_INGREDIENT_FIRST_ENABLED === 'true';
  ```
- [ ] Test alongside existing config workflow

### Task 7: Add Loading and Error States
- [ ] Create loading skeleton for ingredient list
- [ ] Add error boundary around ingredient components
- [ ] Show meaningful error messages:
  - [ ] Network errors
  - [ ] Permission errors
  - [ ] Validation errors
- [ ] Add retry mechanisms for failed operations
- [ ] Implement offline indicators

### Task 8: Create Component Tests
- [ ] Create test files in `__tests__` directories
- [ ] Test IngredientList:
  - [ ] Rendering with various ingredient counts
  - [ ] Search and filter functionality
  - [ ] Selection and event handling
- [ ] Test IngredientEditor:
  - [ ] Loading ingredient data
  - [ ] Editing sections and tests
  - [ ] Save/cancel workflows
- [ ] Test integration with CodeMirror
- [ ] Test store state management

## Dev Notes

### Architecture Context

**Svelte 5 Component Patterns**
[Source: Existing codebase uses Svelte 5 runes]
```typescript
// Props definition with TypeScript
let { prop1, prop2 = defaultValue } = $props();

// State management with runes
let localState = $state(initialValue);
let computed = $derived(() => expression);

$effect(() => {
  // Side effects
});
```

**Existing UI Components**
[Source: src/lib/Sidebar.svelte]
- Already using $state and $props
- Filter states for healthSystem, domain, subdomain
- Search functionality implemented
- Can reuse patterns for ingredient filtering

**CodeMirror Integration**
[Source: src/lib/CodeEditor.svelte]
```typescript
let { 
  value = '', 
  language = 'javascript', 
  onChange = (newValue: string) => {},
  onFormatRequest = () => {}
} = $props();
```
- CodeMirror already integrated with themes
- Supports both JavaScript and HTML modes
- Has Fira Code font configured

**Store Pattern for Svelte 5**
[Source: CLAUDE.md guidance]
- Save stores as `*.svelte.ts` files
- Use rune syntax in stores
- Class-based stores with getters
- Reactive derived values

**Visual Design from Brainstorming**
[Source: docs/brainstorming-session-results.md]
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“¦ Calcium                          Used by: 12  â”‚
â”‚ Category: Micronutrient | Last edited: 2 days agoâ”‚
â”‚ [Edit Content] [View Tests] [Usage Analysis]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Type Definitions**
[Source: From Story 3.1 - models/ingredient.ts]
```typescript
interface Ingredient {
  id: string;
  keyname: string;
  displayName: string;
  category: string;
  sections: Section[];
  tests: TestCase[];
  variants: Map<string, PopulationVariant>;
  metadata: IngredientMetadata;
}
```

### Integration Requirements

**Coexistence with Existing UI**
- IngredientPanel should be a separate tab/mode
- Should not interfere with existing config workflow
- Use feature flag for gradual rollout
- Maintain visual consistency

**Performance Considerations**
- Virtual scrolling for large ingredient lists
- Lazy load editor only when needed
- Debounce search input
- Cache ingredient data locally

### Testing Standards

[Source: Project conventions]
- Component tests with Vitest
- Test user interactions
- Mock service calls
- Test accessibility

### Important Notes

**User Requirements from PRD:**
- Users want BOTH workflows available
- Direct editing without transformation
- Quick access to ingredient content
- Visual indicators for understanding relationships

**From Previous Stories:**
- Story 3.1: Type definitions available
- Story 3.2: IngredientService for data operations
- Story 3.3: Transformation service for compatibility

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-31 | 1.0 | Initial story creation from Epic 3 PRD | Bob (SM) |

## Dev Agent Record

*To be populated during implementation*

### Agent Model Used
*To be populated*

### Debug Log References
*To be populated*

### Completion Notes List
*To be populated*

### File List
*To be populated*

## QA Results

*To be populated after implementation*