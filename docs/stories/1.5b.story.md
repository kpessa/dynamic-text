# Story 1.5b: Individual Ingredient Import/Export

## Status
Completed

## Story
**As a** User,
**I want** To import and export individual ingredients from the INGREDIENT array,
**so that** I can share specific ingredient configurations and build custom ingredient libraries

## Acceptance Criteria
1. Export must generate valid JSON for a single ingredient with all its properties
2. Import must correctly parse and validate individual ingredient JSON
3. The NOTE array with TEXT properties must be handled correctly during import/export
4. Import must merge the ingredient into an existing configuration without duplicates
5. System must support batch import/export of multiple ingredients
6. Validation must ensure all required ingredient fields are present
7. User must be able to select specific ingredients for export from a list
8. Duplicate detection must check KEYNAME field and warn before overwriting
9. Import/export must correctly transform between section format (for editing) and NOTE array format (for schema compliance)

## Tasks / Subtasks
- [x] Task 0: Integrate Section-NOTE Transformation (AC: 3, 9)
  - [x] Import `noteTransformService` from Story 1.5a implementation
  - [x] Apply transformation during ingredient import
  - [x] Apply reverse transformation during ingredient export
  - [x] Ensure individual ingredient handling matches full config approach
  
- [x] Task 1: Create IngredientService (AC: 1, 2, 3)
  - [x] Create `/src/lib/services/ingredientService.ts`
  - [x] Define Ingredient TypeScript interface matching schema structure
  - [x] Implement `exportIngredient()` method for single ingredient
  - [x] Implement `importIngredient()` method with validation
  - [x] Implement `exportIngredients()` method for batch export
  - [x] Implement `importIngredients()` method for batch import
  - [x] Handle NOTE array structure correctly
  
- [x] Task 2: Ingredient Validation (AC: 2, 6)
  - [x] Create `validateIngredient()` method
  - [x] Check required fields (KEYNAME, DISPLAY, MNEMONIC, UOM_DISP, TYPE)
  - [x] Validate TYPE enum values
  - [x] Validate REFERENCE_RANGE threshold values
  - [x] Validate numeric fields (OSMO_RATIO, PRECISION)
  - [x] Return specific validation error messages
  
- [x] Task 3: Duplicate Detection and Merging (AC: 4, 8)
  - [x] Implement `checkDuplicateIngredient()` using KEYNAME
  - [x] Create merge strategy options (overwrite, skip, rename)
  - [x] Add `mergeIngredient()` method with conflict resolution
  - [x] Generate unique KEYNAME if rename option selected
  - [x] Maintain ingredient order after merge
  
- [x] Task 4: Create Ingredient Selection UI (AC: 7)
  - [x] Create `/src/lib/components/IngredientSelector.svelte`
  - [x] Display ingredient list with checkboxes
  - [x] Show ingredient details (DISPLAY, TYPE, UOM_DISP)
  - [x] Add search/filter functionality by name or type
  - [x] Add select all/none buttons
  - [x] Show count of selected ingredients
  
- [x] Task 5: Create Import UI Components (AC: 2, 3, 4, 8)
  - [x] Create `/src/lib/components/IngredientImportModal.svelte`
  - [x] Add file upload for single or multiple ingredients
  - [x] Display ingredient preview before import
  - [x] Show duplicate warning with KEYNAME conflicts
  - [x] Provide merge strategy options (overwrite/skip/rename)
  - [x] Display import results summary
  
- [x] Task 6: Create Export UI Components (AC: 1, 5, 7)
  - [x] Create `/src/lib/components/IngredientExportModal.svelte`
  - [x] Integrate IngredientSelector component
  - [x] Add export format options (single file vs multiple files)
  - [x] Show JSON preview of selected ingredients
  - [x] Add filename customization options
  - [x] Support clipboard copy as alternative to file download
  
- [x] Task 7: NOTE Array Handling (AC: 3)
  - [x] Ensure NOTE array structure is preserved
  - [x] Handle empty NOTE arrays correctly
  - [x] Preserve TEXT property in each NOTE object
  - [x] Support multiple NOTE entries per ingredient
  - [x] Validate NOTE structure during import
  
- [x] Task 8: Batch Operations (AC: 5)
  - [x] Implement batch file selection in UI
  - [x] Add progress indicator for batch operations
  - [x] Create batch validation with error summary
  - [x] Support ZIP file export for multiple ingredients
  - [x] Add batch import from folder selection
  
- [x] Task 9: Integration with Main Application (AC: 1, 2, 7)
  - [x] Add "Manage Ingredients" button to toolbar
  - [x] Create ingredient management panel
  - [x] Connect to existing TPN configuration store
  - [x] Update ingredient count display
  - [x] Add keyboard shortcuts for ingredient operations
  
- [x] Task 10: Add Unit Tests (AC: 1, 2, 3, 6, 8)
  - [x] Create `/src/lib/services/__tests__/ingredientService.test.ts`
  - [x] Test single ingredient export/import
  - [x] Test batch operations
  - [x] Test NOTE array handling
  - [x] Test duplicate detection
  - [x] Test validation with invalid data
  
- [x] Task 11: Add E2E Tests (AC: 1, 4, 5, 7)
  - [x] Create `/e2e/specs/ingredient-management.spec.ts`
  - [x] Test ingredient selection UI
  - [x] Test import with duplicates
  - [x] Test batch export workflow
  - [x] Test merge strategies

## Dev Notes

### Previous Story Insights
This story is split from the original Story 1.5 to handle the specific requirement of individual ingredient management. Ingredients are complex objects within the INGREDIENT array of TPN configurations.

### Ingredient Structure
**Ingredient Schema** [Source: /refs/schema.json]:
```typescript
interface Ingredient {
  KEYNAME: string;          // Unique identifier - used for duplicate detection
  DISPLAY: string;          // Human-readable name
  MNEMONIC: string;         // Short code
  UOM_DISP: string;         // Unit of measure for display
  TYPE: 'Macronutrient' | 'Micronutrient' | 'Additive' | 'Salt' | 'Diluent' | 'Other';
  OSMO_RATIO: number;       // Osmolality ratio
  EDITMODE: 'None' | 'Custom';
  PRECISION: number;        // Number of decimal places
  SPECIAL: string;          // Special handling notes
  NOTE: Array<{            // Important: Array of objects with TEXT property
    TEXT: string;
  }>;
  ALTUOM: Array<{          // Alternative units of measure
    NAME: string;
    UOM_DISP: string;
  }>;
  REFERENCE_RANGE: Array<{  // Clinical reference ranges
    THRESHOLD: 'Feasible Low' | 'Critical Low' | 'Normal Low' | 
               'Normal High' | 'Critical High' | 'Feasible High';
    VALUE: number;
  }>;
  LABS: Array<{            // Associated lab values
    DISPLAY: string;
    EVENT_SET_NAME: string;
    GRAPH: 0 | 1;
  }>;
  CONCENTRATION: {         // Concentration for calculations
    STRENGTH: number;
    STRENGTH_UOM: string;
    VOLUME: number;
    VOLUME_UOM: string;
  };
  EXCLUDES: Array<{        // Mutually exclusive ingredients
    keyname: string;
  }>;
}
```

### Example Ingredient from Reference Config
[Source: /refs/neo-build-main-choc.json]
```json
{
  "KEYNAME": "Weight",
  "DISPLAY": "TPN Dosing Weight",
  "MNEMONIC": "doseweightkg",
  "UOM_DISP": "kg",
  "TYPE": "Other",
  "OSMO_RATIO": 0,
  "EDITMODE": "None",
  "PRECISION": 2,
  "SPECIAL": "",
  "NOTE": [],
  "ALTUOM": [],
  "REFERENCE_RANGE": [
    {
      "THRESHOLD": "Feasible High",
      "VALUE": 20
    }
  ],
  "LABS": [
    {
      "DISPLAY": "Dose Calculating Weight",
      "EVENT_SET_NAME": "TPN Dose Calculating Weight",
      "GRAPH": 1
    }
  ],
  "CONCENTRATION": {
    "STRENGTH": 0,
    "STRENGTH_UOM": "",
    "VOLUME": 0,
    "VOLUME_UOM": ""
  },
  "EXCLUDES": []
}
```

### Duplicate Detection Strategy
- Primary key: KEYNAME field (must be unique within configuration)
- When importing, check existing ingredients for KEYNAME match
- If duplicate found, offer options:
  1. Overwrite existing (replace completely)
  2. Skip import (keep existing)
  3. Rename incoming (append suffix like "_imported" or "_2")

### File Locations
[Source: architecture/unified-project-structure.md]
- Services: `/src/lib/services/`
- Components: `/src/lib/components/`
- Unit Tests: `/src/lib/services/__tests__/`
- E2E Tests: `/e2e/specs/`

### Technical Constraints
- KEYNAME must be unique within a configuration
- All numeric values must preserve precision as specified
- Empty arrays must be preserved (not converted to null)
- NOTE array may be empty but must always be an array
- TYPE field has strict enum values that must be validated

### Testing Standards
[Source: architecture/testing-strategy.md]
- Unit tests use Vitest framework
- Test files in `__tests__` directories
- E2E tests use Playwright
- Test both single and batch operations
- Test edge cases (empty arrays, null values)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-30 | 1.1 | Added section transformation requirement (AC 9, Task 0) | John (Product Manager) |
| 2025-01-30 | 1.0 | Initial story creation - Split from original Story 1.5 | Bob (Scrum Master) |

## Dev Agent Record
*To be populated during development*

### Agent Model Used
claude-opus-4-1-20250805

### Debug Log References
- Integrated noteTransformService from Story 1.5a for section-NOTE array transformation
- Created comprehensive ingredientService with full validation and merge strategies
- Implemented UI components for ingredient selection, import, and export
- Added ingredient manager component for overall workflow management
- Integrated with NavbarActions to add "Manage Ingredients" button
- Created thorough unit tests covering all service methods
- Developed E2E tests for all major user workflows

### Completion Notes List
- Successfully reused noteTransformService from Story 1.5a for NOTE array transformations
- Implemented complete ingredient import/export functionality with validation
- Created user-friendly UI with search, filter, and batch operations
- Added three merge strategies for duplicate handling (skip, overwrite, rename)
- Integrated clipboard copy functionality for quick exports
- Provided comprehensive test coverage (unit and E2E)
- Added support for both single and multiple file exports
- Implemented preview functionality before import/export operations

### File List
**Created:**
- `/src/lib/services/ingredientService.ts`
- `/src/lib/components/IngredientSelector.svelte`
- `/src/lib/components/IngredientImportModal.svelte`
- `/src/lib/components/IngredientExportModal.svelte`
- `/src/lib/components/IngredientManager.svelte`
- `/src/lib/services/__tests__/ingredientService.test.ts`
- `/e2e/specs/ingredient-management.spec.ts`

**Modified:**
- `/src/lib/NavbarActions.svelte` - Added Manage Ingredients button support

### Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-30 | 1.0 | Complete implementation of all 12 tasks | James (Dev Agent) |

## QA Results

### Review Date: 2025-01-30

### Reviewed By: Quinn (Test Architect)

### Test Architecture Assessment

#### Requirements Traceability
✅ **Complete Coverage**: All 9 acceptance criteria are fully implemented and traceable to code:
- AC1: Export generates valid JSON ✓ (ingredientService.exportIngredient)
- AC2: Import validates JSON ✓ (ingredientService.importIngredient with validation)
- AC3: NOTE array handling ✓ (noteTransformService integration verified)
- AC4: Merge without duplicates ✓ (mergeIngredient with strategies)
- AC5: Batch operations ✓ (exportIngredients/importIngredients)
- AC6: Field validation ✓ (validateIngredient method)
- AC7: Selection UI ✓ (IngredientSelector.svelte)
- AC8: Duplicate detection ✓ (checkDuplicateIngredient with KEYNAME)
- AC9: Section transformation ✓ (Story 1.5a integration)

#### Test Coverage Analysis
✅ **Unit Tests**: Comprehensive coverage in ingredientService.test.ts
- Single ingredient export/import
- Batch operations
- NOTE array transformation
- Duplicate detection logic
- Validation scenarios

✅ **E2E Tests**: User workflows covered in ingredient-management.spec.ts
- Ingredient manager UI interaction
- Import flow with preview
- Export with selection
- Duplicate handling scenarios

#### Risk Assessment
**Risk Level: LOW**
- Core functionality stable
- Proper error handling implemented
- Schema compliance validated
- Integration with Story 1.5a successful

#### Code Quality Observations
✅ **Strengths**:
- Clean service architecture with single responsibility
- TypeScript interfaces match schema.json precisely
- Proper separation of concerns (service/UI/validation)
- Successful reuse of noteTransformService from Story 1.5a
- Three merge strategies provide flexibility (skip/overwrite/rename)

⚠️ **Minor Improvements Suggested**:
- Edge case testing for malformed JSON could be enhanced
- Private method documentation could be more detailed

#### Non-Functional Requirements
✅ **Performance**: Batch operations handle large datasets efficiently
✅ **Usability**: Clear UI with search, filter, and preview capabilities
✅ **Maintainability**: Well-structured code with clear separation
✅ **Security**: Input validation prevents injection attacks

### Gate Status

Gate: PASS → docs/qa/gates/1.5b-individual-ingredient-import-export.yml