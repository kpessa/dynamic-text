# Story 4.4.1: Firebase Service Consolidation

## Status
Ready for Development

## Story
**As a** developer,
**I want** a single, unified Firebase service instead of 4 separate ones,
**So that** we eliminate code duplication, reduce confusion, and have a single source of truth for Firebase operations.

## Acceptance Criteria
1. All Firebase operations consolidated into the existing `firebaseDataService.ts`
2. The 4 legacy Firebase services are safely removed
3. All existing function signatures preserved (adapter layer if needed)
4. All Firebase operations continue to work exactly as before
5. No breaking changes to any components using Firebase services
6. Code reduction of 200-300 lines achieved
7. Full regression testing confirms no functionality loss

## Tasks / Subtasks

### TDD Workflow (MANDATORY - Follow this exact order)

**Phase 1: Write Tests First**
- [ ] Write tests for all Firebase service operations
  - [ ] Test save operations (ingredients, configs, references)
  - [ ] Test load operations (single and batch)
  - [ ] Test delete operations
  - [ ] Test query operations (by health system, by type)
  - [ ] Test real-time sync functionality
  - [ ] Test error handling scenarios
- [ ] Write adapter tests to verify signature compatibility
- [ ] Write integration tests for components using Firebase
- [ ] ✅ All tests written and failing (red phase)

**Phase 2: Make Tests Pass (Minimal Implementation)**
- [ ] Audit Existing Firebase Services (AC: 1, 2)
  - [ ] Document functions in `FirebaseService.ts` (10KB file)
  - [ ] Document functions in `firebaseEmulatorService.ts` (6KB file) 
  - [ ] Document functions in `firebaseSaveService.ts` (6KB file)
  - [ ] Document functions in `tpnConfigFirebaseService.ts` (14KB file)
  - [ ] Identify truly duplicate vs unique functionality
  - [ ] Map all function usage across codebase
  - [ ] ✅ Audit complete with duplication report

- [ ] Consolidate into firebaseDataService.ts (AC: 1, 3)
  - [ ] Preserve ALL existing public function signatures
  - [ ] Move unique functions from each service
  - [ ] Merge duplicate implementations (keep best version)
  - [ ] Create compatibility exports if needed
  - [ ] Add deprecation notices for old imports
  - [ ] ✅ All tests passing with consolidated service

- [ ] Create Adapter Layer (AC: 3, 5)
  - [ ] Export old service names from firebaseDataService
  - [ ] Map old function calls to new implementations
  - [ ] Ensure zero changes needed in consuming components
  - [ ] Test each adapter thoroughly
  - [ ] ✅ Components work without modification

- [ ] Update Import Statements (AC: 5)
  - [ ] Find all imports of old Firebase services
  - [ ] Update to import from firebaseDataService
  - [ ] Verify no runtime errors
  - [ ] Keep adapter exports as fallback
  - [ ] ✅ All imports updated successfully

- [ ] Remove Legacy Services (AC: 2, 6)
  - [ ] Backup the 4 service files first
  - [ ] Delete FirebaseService.ts
  - [ ] Delete firebaseEmulatorService.ts  
  - [ ] Delete firebaseSaveService.ts
  - [ ] Delete tpnConfigFirebaseService.ts
  - [ ] Verify build still succeeds
  - [ ] ✅ Legacy services removed, ~1000 lines eliminated

**Phase 3: Refactor for Maintainability**
- [ ] Organize firebaseDataService.ts logically
  - [ ] Group by operation type (CRUD, queries, sync)
  - [ ] Add clear section comments
  - [ ] Ensure consistent error handling
  - [ ] Add TypeScript types where missing
- [ ] Document the consolidated API
  - [ ] Add JSDoc comments for all public functions
  - [ ] Create usage examples
  - [ ] Document any behavior changes
- [ ] ✅ Service is clean and well-documented

### Regression Testing (AC: 4, 7)
- [ ] Manual testing of all Firebase operations
  - [ ] Create new ingredient
  - [ ] Load existing ingredient
  - [ ] Update ingredient
  - [ ] Delete ingredient
  - [ ] Test real-time sync between tabs
  - [ ] Test offline mode and recovery
  - [ ] Test error scenarios
- [ ] Run existing E2E tests
- [ ] Performance comparison (should be same or better)
- [ ] ✅ All functionality verified working

## Dev Notes

### Current Firebase Service Landscape
[Source: File system analysis]
- `src/lib/services/FirebaseService.ts` - 10,376 bytes (marked for deletion in git)
- `src/lib/services/firebaseEmulatorService.ts` - 6,470 bytes (marked for deletion)
- `src/lib/services/firebaseSaveService.ts` - 6,327 bytes (marked for deletion)
- `src/lib/services/tpnConfigFirebaseService.ts` - 14,509 bytes (marked for deletion)
- `src/lib/firebaseDataService.ts` - Already exists as consolidated service

Total to remove: ~37KB of duplicated code

### Architecture Guidance
[Source: architecture-shards/4-architecture-patterns.md#Service Layer Pattern]
- Services should implement clear interfaces
- Async operations return Promises
- State exposed via getters
- Events via callbacks for real-time updates

### TypeScript Requirements
[Source: architecture-shards/6-component-specifications.md#TypeScript First]
- ALWAYS use TypeScript over JavaScript
- Maintain strict type safety
- All service methods must be typed

### Refactoring Constraints
[Source: Epic 4.4 Conservative Refactoring]
- NO breaking changes allowed
- Each change must be independently testable
- Commit after each successful step
- Rollback immediately if issues detected

### Function Signature Preservation
CRITICAL: The consolidation must not break any existing code. Use these patterns:

```typescript
// If old service had:
class OldService {
  saveIngredient(data) { /* ... */ }
}

// New consolidated service should:
class FirebaseDataService {
  // Keep exact same signature
  saveIngredient(data) { /* ... */ }
  
  // Or provide adapter:
  legacySaveIngredient(data) {
    return this.saveIngredient(data);
  }
}

// Export compatibility layer:
export const FirebaseService = {
  saveIngredient: (data) => firebaseDataService.saveIngredient(data)
};
```

### Testing Requirements
[Source: architecture-shards/3-technology-stack.md#Development Tools]
- Use Vitest for unit tests
- Test each service method independently
- Verify backward compatibility
- Use Playwright MCP for manual verification

### Risk Mitigation
- Create backup of all 4 services before deletion
- Test after EACH consolidation step
- Keep adapter layer until all components verified
- Have rollback plan ready: `git checkout de2c0b0`

## Testing
- Unit tests for every Firebase operation
- Integration tests with components
- Manual testing of all user workflows
- Performance benchmarks before/after

## Definition of Done
- [ ] All Firebase operations working as before
- [ ] 4 legacy services removed
- [ ] firebaseDataService.ts is the single source of truth
- [ ] No components required modification
- [ ] All tests passing
- [ ] Code reduction of 200-300 lines achieved
- [ ] Documentation updated
- [ ] Committed to git with clear message

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-01 | 1.0 | Initial story creation from Epic 4.4 | Scrum Master Bob |

## Dev Agent Record
### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

## QA Results
_To be filled by QA agent_