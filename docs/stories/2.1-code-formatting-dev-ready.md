# Story 2.1: JavaScript Code Formatting in Dynamic Sections - DEVELOPER HANDOFF

## ğŸ¯ Story Goal
**As a** content developer using the Dynamic Text Editor  
**I want** to automatically format JavaScript code in dynamic sections  
**So that** my code is consistently formatted, readable, and follows best practices

## ğŸ“‹ Pre-Implementation Checklist
- [ ] Review existing CodeMirror setup in `src/lib/CodeEditor.svelte`
- [ ] Check current dynamic section implementation in `src/App.svelte`
- [ ] Verify no existing Prettier dependencies in `package.json`
- [ ] Understand current toolbar implementation for dynamic sections

## ğŸ”§ Implementation Steps

### Step 1: Add Prettier Dependency
```bash
pnpm add prettier prettier/standalone prettier/parser-babel
```
Or use CDN approach in `index.html`:
```html
<script src="https://unpkg.com/prettier@3.1.0/standalone.js"></script>
<script src="https://unpkg.com/prettier@3.1.0/plugins/babel.js"></script>
```

### Step 2: Create Format Service
Create `src/lib/services/codeFormatterService.js`:
```javascript
import prettier from 'prettier/standalone';
import parserBabel from 'prettier/parser-babel';

export const formatJavaScript = (code) => {
  try {
    const formatted = prettier.format(code, {
      parser: 'babel',
      plugins: [parserBabel],
      semi: false,
      singleQuote: true,
      tabWidth: 2,
      trailingComma: 'es5'
    });
    return { success: true, formatted };
  } catch (error) {
    return { success: false, error: error.message };
  }
};

export const loadFormatterConfig = () => {
  return JSON.parse(localStorage.getItem('prettierConfig') || '{}');
};

export const saveFormatterConfig = (config) => {
  localStorage.setItem('prettierConfig', JSON.stringify(config));
};
```

### Step 3: Add Format Button to Dynamic Sections
In `src/App.svelte`, locate the dynamic section rendering (around line 1080):

1. Add format button to section header:
```svelte
{#if section.type === 'dynamic'}
  <button 
    class="format-btn"
    onclick={() => formatSection(index)}
    title="Format code (Alt+Shift+F)"
  >
    <Icon name="code-format" />
  </button>
{/if}
```

2. Add format function:
```javascript
function formatSection(sectionIndex) {
  const section = sections[sectionIndex];
  if (section.type !== 'dynamic') return;
  
  const result = formatJavaScript(section.content);
  
  if (result.success) {
    // Store for undo
    undoStack.push({ 
      action: 'format', 
      sectionIndex, 
      oldContent: section.content 
    });
    
    sections[sectionIndex].content = result.formatted;
    showNotification('Code formatted successfully', 'success');
  } else {
    showNotification(`Format error: ${result.error}`, 'error');
  }
}
```

### Step 4: Add Keyboard Shortcut
In `src/lib/CodeEditor.svelte`, add keyboard handler:
```javascript
$effect(() => {
  if (editorView) {
    editorView.dom.addEventListener('keydown', (e) => {
      if (e.altKey && e.shiftKey && e.key === 'F') {
        e.preventDefault();
        const sectionIndex = getCurrentSectionIndex();
        if (sectionIndex !== -1) {
          formatSection(sectionIndex);
        }
      }
    });
  }
});
```

### Step 5: Add Visual Feedback
Add to `src/App.svelte` styles:
```css
.format-btn {
  padding: 4px 8px;
  background: #f3f4f6;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
}

.format-btn:hover {
  background: #e5e7eb;
}

.format-btn.formatting {
  background: #3b82f6;
  color: white;
  animation: pulse 0.5s;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}
```

### Step 6: Implement Undo Support
Enhance existing undo mechanism:
```javascript
function undo() {
  const lastAction = undoStack.pop();
  if (!lastAction) return;
  
  if (lastAction.action === 'format') {
    sections[lastAction.sectionIndex].content = lastAction.oldContent;
    showNotification('Format undone', 'info');
  }
  // ... handle other undo types
}
```

## ğŸ§ª Testing Instructions

### Manual Testing
1. **Basic Format**: 
   - Add unformatted code: `const x={a:1,b:2}`
   - Click format button
   - Verify formatted to: `const x = { a: 1, b: 2 }`

2. **Error Handling**:
   - Add invalid JS: `const x = {`
   - Click format
   - Verify error notification appears

3. **Keyboard Shortcut**:
   - Focus on dynamic section
   - Press Alt+Shift+F
   - Verify formatting occurs

4. **Undo**:
   - Format code
   - Press Ctrl+Z
   - Verify original code restored

### Automated Testing
Create `src/lib/services/__tests__/codeFormatterService.test.js`:
```javascript
import { describe, it, expect } from 'vitest';
import { formatJavaScript } from '../codeFormatterService';

describe('CodeFormatterService', () => {
  it('formats simple object', () => {
    const input = 'const x={a:1,b:2}';
    const result = formatJavaScript(input);
    expect(result.success).toBe(true);
    expect(result.formatted).toContain('{ a: 1, b: 2 }');
  });
  
  it('handles syntax errors', () => {
    const input = 'const x = {';
    const result = formatJavaScript(input);
    expect(result.success).toBe(false);
    expect(result.error).toBeDefined();
  });
});
```

## ğŸ“¦ Files to Modify/Create
1. âœ… Create: `src/lib/services/codeFormatterService.js`
2. âœ… Modify: `src/App.svelte` (add format button and logic)
3. âœ… Modify: `src/lib/CodeEditor.svelte` (keyboard shortcut)
4. âœ… Modify: `package.json` (add Prettier dependency)
5. âœ… Create: `src/lib/services/__tests__/codeFormatterService.test.js`

## âš ï¸ Edge Cases to Handle
- Empty content
- Non-JavaScript content in dynamic section
- Very large code blocks (performance)
- Concurrent formatting requests
- CodeMirror cursor position preservation

## ğŸ¯ Definition of Done
- [ ] Format button appears on all dynamic sections
- [ ] Alt+Shift+F keyboard shortcut works
- [ ] Formatting preserves code functionality
- [ ] Errors show user-friendly notifications
- [ ] Undo/redo works correctly
- [ ] Tests pass
- [ ] No console errors
- [ ] Feature works in Chrome, Firefox, Safari

## ğŸš€ MVP Delivery
Focus on:
1. Basic format button with Prettier
2. Simple error handling
3. Visual feedback

Defer:
- Custom config UI
- Auto-format on blur
- Format all sections

## ğŸ’¡ Developer Notes
- Prettier standalone is ~600KB - consider lazy loading
- Use existing notification system from App.svelte
- Match existing UI patterns (look at test runner buttons)
- Consider debouncing format requests