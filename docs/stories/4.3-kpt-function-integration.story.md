# Story 4.3: KPT Function Integration & Verification

## Status
Ready for Development

## Story
**As a** medical content creator,
**I want** access to KPT custom functions when writing dynamic JavaScript sections,
**so that** I can create specialized medical calculations and logic using the KPT namespace functions.

## Acceptance Criteria
1. KPT functions are accessible via `me.kpt` namespace in dynamic text editor
2. All KPT functions from the legacy system are available and functional
3. KPT function reference panel is added to the UI for easy discovery
4. Comprehensive tests verify all KPT functions work correctly
5. KPT functions work in both preview and export modes
6. Documentation is created for all available KPT functions
7. Error handling provides clear messages when KPT functions fail

## Tasks / Subtasks

### TDD Workflow (MANDATORY - Follow this exact order)
**Phase 1: Write Tests First**
- [ ] Write tests for KPT namespace availability in me object
- [ ] Write unit tests for each KPT function signature
- [ ] Write tests for KPT function calculations
- [ ] Write tests for error handling and edge cases
- [ ] Write integration tests for worker context execution
- [ ] Write E2E tests for KPT functions in editor
- [ ] Write tests for KPT reference panel functionality

**Phase 2: Make Tests Pass (Minimal Implementation)**
- [ ] Audit Current KPT Function Availability (AC: 1, 2)
  - [ ] Review src/lib/tpnLegacy.js for KPT function definitions
  - [ ] Check src/lib/services/secureCodeExecution.ts for KPT exposure
  - [ ] Verify KPT namespace initialization in worker context
  - [ ] Document all available KPT functions
  - [ ] Identify any missing or broken functions
  - [ ] ✅ Verify audit tests pass

- [ ] Restore KPT Function Access (AC: 1, 2)
  - [ ] Update public/workers/codeWorker.js to include KPT namespace
  - [ ] Ensure me.kpt object is properly initialized
  - [ ] Verify all KPT functions are bound to correct context
  - [ ] Add KPT function validation on initialization
  - [ ] Test each KPT function individually
  - [ ] ✅ Verify all KPT function tests pass

- [ ] Create KPT Function Reference Panel (AC: 3)
  - [ ] Create new component src/lib/KPTFunctionReference.svelte
  - [ ] Add collapsible panel to editor interface
  - [ ] Display function signatures and descriptions
  - [ ] Add copy-to-clipboard for function examples
  - [ ] Include search/filter functionality
  - [ ] ✅ Verify reference panel tests pass

- [ ] Enhance Error Handling (AC: 7)
  - [ ] Add try-catch blocks around KPT function calls
  - [ ] Implement user-friendly error messages
  - [ ] Log errors for debugging purposes
  - [ ] Add validation for function parameters
  - [ ] Provide helpful hints for common mistakes
  - [ ] ✅ Verify error handling tests pass

- [ ] Verify Export and Preview Modes (AC: 5)
  - [ ] Test KPT functions in preview panel
  - [ ] Verify functions work in exported JSON
  - [ ] Ensure consistent behavior across modes
  - [ ] Test with complex multi-function scenarios
  - [ ] Validate output accuracy
  - [ ] ✅ Verify export/preview tests pass

**Phase 3: Refactor for Maintainability**
- [ ] Extract KPT functions into dedicated KPTService class (max 400 lines)
- [ ] Create KPTFunctionRegistry for function metadata (max 200 lines)
- [ ] Split KPTFunctionReference panel into sub-components (max 250 lines each)
- [ ] Extract KPT validation logic into KPTValidator service (max 150 lines)
- [ ] Create reusable KPTFunctionCard component for display
- [ ] Consolidate KPT error handling into KPTErrorHandler
- [ ] ✅ Verify ALL tests still pass after refactoring
- [ ] ✅ Ensure no module exceeds 500 lines of code
- [ ] ✅ Maintain 100% KPT function availability
- [ ] ✅ Achieve minimum 90% test coverage for KPT modules

- [ ] Implement KPT Function Testing Suite (AC: 4)
  - [ ] Create tests/kpt/kptFunctions.test.ts
  - [ ] Write unit tests for each KPT function
  - [ ] Add integration tests for complex calculations
  - [ ] Test edge cases and error conditions
  - [ ] Verify function behavior matches legacy system

- [ ] Create KPT Documentation (AC: 6)
  - [ ] Create docs/KPT_FUNCTIONS_REFERENCE.md
  - [ ] Document each function with signature and examples
  - [ ] Add common use cases and patterns
  - [ ] Include troubleshooting guide
  - [ ] Create quick reference card

## Dev Notes

### KPT Function Context
KPT (presumably Key Population Type or similar medical acronym) functions are custom medical calculation functions that should be available in the dynamic JavaScript execution context via the `me` object.

### Current Implementation Status
[User reported]: "I need to make sure I have the custom KPT functions when I'm writing dynamic text. I feel like I may have lost that functionality."

### Code Locations
[Source: architecture-shards/4-architecture-patterns.md#Component Architecture]
- TPN Legacy functions: src/lib/tpnLegacy.js
- Secure execution: src/lib/utils/secureCodeExecution.ts
- Worker file: public/workers/codeWorker.js

### KPT Function Categories (from legacy system)
Based on typical TPN/medical systems, KPT functions likely include:
- Population type calculations
- Dosage calculations
- Range validations
- Unit conversions
- Medical formulas

### Integration Points
- The `me` object is passed to dynamic JavaScript execution
- KPT functions should be properties of `me.kpt`
- Functions must be serializable for worker context
- Must maintain backward compatibility with existing content

### Security Considerations
- KPT functions run in sandboxed worker environment
- No direct DOM access allowed
- Functions should be pure (no side effects)
- Input validation required to prevent injection

## Testing
[Source: architecture-shards/3-technology-stack.md#Development Tools]
- Unit tests using Vitest for each KPT function
- Integration tests for the complete KPT namespace
- E2E tests using Playwright to verify UI integration
- Performance tests to ensure functions don't slow execution
- Regression tests against known good outputs

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-01 | 1.0 | Initial story creation | Scrum Master Bob |

## Dev Agent Record
### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

## QA Results
_To be filled by QA agent_