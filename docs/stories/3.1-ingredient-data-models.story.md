# Story 3.1: Create Ingredient Data Models and TypeScript Interfaces

## Status
Ready for Development

## Story
**As a** developer,
**I want** to define the new ingredient and config manifest data structures,
**So that** we have a type-safe foundation for the ingredient-first enhancement

## Acceptance Criteria
1. TypeScript interface for Ingredient entity with sections, tests, and variants
2. TypeScript interface for ConfigManifest that references ingredients  
3. Type definitions for migration and transformation utilities
4. All interfaces properly exported and documented
5. No breaking changes to existing type definitions

## TDD Approach
**Following TDD Agentic Workflow:**
1. **Write Tests First** - Create comprehensive test suite for type guards and validation
2. **Make It Green** - Implement interfaces and type guards to pass tests
3. **Refactor** - Improve type definitions for clarity and maintainability

## Tasks / Subtasks

### Task 0: Write Type Guard Tests FIRST (TDD Step 1)
- [ ] Create test file `src/lib/models/__tests__/type-guards.test.ts`
- [ ] Write tests for `isIngredient()` type guard:
  ```typescript
  describe('isIngredient type guard', () => {
    it('should return true for valid ingredient', () => {
      const valid = { id: 'calcium', keyname: 'Calcium', sections: [], tests: [] };
      expect(isIngredient(valid)).toBe(true);
    });
    
    it('should return false for missing required fields', () => {
      const invalid = { id: 'calcium' }; // Missing sections
      expect(isIngredient(invalid)).toBe(false);
    });
  });
  ```
- [ ] Write tests for `isConfigManifest()` type guard
- [ ] Write tests for `isLegacyConfig()` type guard
- [ ] Write validation tests for complex nested structures
- [ ] Run tests - all should fail initially (Red phase)

### Task 1: Create Core Ingredient Interface (AC: 1)
- [ ] Create new file `src/lib/models/ingredient.ts`
- [ ] Define `Ingredient` interface with id, keyname, displayName, category fields
- [ ] Add `sections: Section[]` property for direct content storage
- [ ] Add `tests: TestCase[]` property for test storage
- [ ] Define `PopulationVariant` interface for neonatal/pediatric/adult differences
- [ ] Add `variants: Map<string, PopulationVariant>` to Ingredient interface
- [ ] Add `metadata: IngredientMetadata` interface with timestamps, version, author

### Task 2: Create Config Manifest Interface (AC: 2)
- [ ] Create new file `src/lib/models/config.ts`
- [ ] Define `ConfigManifest` interface with id, name, source properties
- [ ] Define `IngredientReference` interface with ingredientId and optional overrides
- [ ] Add `ingredientRefs: IngredientReference[]` array to ConfigManifest
- [ ] Define `ConfigSource` interface to track original file/import details
- [ ] Add `settings: ConfigSettings` for FLEX-like configuration values

### Task 3: Create Transformation Type Definitions (AC: 3)
- [ ] Create new file `src/lib/models/transformations.ts`
- [ ] Define `TransformationResult<T>` generic type for transformation operations
- [ ] Create `MigrationOptions` interface for migration configuration
- [ ] Define `DeduplicationResult` interface for import analysis
- [ ] Create `IngredientComparison` interface for similarity detection
- [ ] Add type guards: `isIngredient()`, `isConfigManifest()`, `isLegacyConfig()`

### Task 4: Ensure Backward Compatibility (AC: 5)
- [ ] Verify existing interfaces in `src/lib/types.ts` (if exists) remain unchanged
- [ ] Create type alias if needed: `type LegacyConfig = any` to preserve old signatures
- [ ] Ensure new interfaces don't conflict with existing type names
- [ ] Add deprecation notices to any interfaces that will be phased out
- [ ] Test that TypeScript compilation succeeds with both old and new types

### Task 5: Add Documentation and Exports (AC: 4)
- [ ] Add JSDoc comments to all interfaces with examples
- [ ] Document the purpose and usage of each property
- [ ] Create barrel export in `src/lib/models/index.ts`
- [ ] Export all interfaces for use by services and components
- [ ] Add README.md in models folder explaining the data model architecture

### Task 6: Create Unit Tests for Type Guards
- [ ] Create test file `src/lib/models/__tests__/type-guards.test.ts`
- [ ] Test `isIngredient()` with valid and invalid objects
- [ ] Test `isConfigManifest()` with various inputs
- [ ] Test `isLegacyConfig()` for backward compatibility
- [ ] Verify type narrowing works correctly in TypeScript

## Dev Notes

### Architecture Context

**Technology Stack**
[Source: architecture/3-technology-stack.md]
- TypeScript 5.9.2 with strict mode enabled
- Svelte 5.35+ with Runes API
- Firebase Firestore 12.0.0 for persistence
- Build tool: Vite 7.0.4

**File Structure**
[Source: architecture/4-architecture-patterns.md]
New model files should be created in:
```
src/lib/models/          # NEW directory for TypeScript interfaces
├── ingredient.ts        # Ingredient entity interface
├── config.ts           # ConfigManifest interface  
├── transformations.ts  # Transformation utilities
└── index.ts           # Barrel export
```

**Service Layer Pattern**
[Source: architecture/4-architecture-patterns.md#service-layer-pattern]
Interfaces should follow the async Promise pattern:
```typescript
export interface ServiceInterface {
  async operation(): Promise<Result>
  get state(): StateType
  onStateChange(callback: (state) => void): void
}
```

**Existing Type System**
Based on the codebase analysis:
- Current types may be inline or in various service files
- No centralized type definition file found yet
- Need to check for existing `Section` and `TestCase` types to reuse

**Data Model Requirements from PRD**
[Source: docs/ingredient-refactor-brownfield-prd.md]

Ingredient entity structure (from brainstorming):
```javascript
{
  id: "calcium",              // Simple, readable ID
  keyname: "Calcium",         // From KEYNAME in config
  displayName: "Calcium",     // From DISPLAY
  category: "Salt",          // From TYPE
  sections: [...],           // Direct storage!
  tests: [...],              // Direct storage!
  variants: {                // Population-specific
    "neonatal": {...},
    "adult": {...}
  },
  metadata: {...}            // Timestamps, version, etc.
}
```

ConfigManifest structure:
```javascript
{
  id: "choc-pediatric-tpn",
  name: "CHOC Pediatric TPN",
  source: {
    path: "refs/child-build-main-choc.json",
    importedAt: timestamp,
    sha256: "..."
  },
  ingredientRefs: [
    { ingredientId: "calcium", overrides: null },
    { ingredientId: "phosphate", overrides: {...} }
  ],
  settings: {...}  // From FLEX section
}
```

### Testing Standards

[Source: Testing strategy not found in architecture docs - using project conventions]
- Test files should be colocated with source files in `__tests__` directories
- Use Vitest if available (check package.json) or Jest
- Focus on type correctness and type guard functionality
- No specific testing framework mentioned in architecture docs

### Important Notes from Previous Stories

Story 1.7 (Safe Refactoring) is currently in progress and has extracted several services. This new model layer will complement those extractions by providing proper type definitions for the data being managed.

The existing `ingredientExtractionService.ts` already exists and may have some type definitions we can build upon or need to maintain compatibility with.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-31 | 1.0 | Initial story creation from Epic 3 PRD | Bob (SM) |

## Dev Agent Record

*To be populated during implementation*

### Agent Model Used
*To be populated*

### Debug Log References
*To be populated*

### Completion Notes List
*To be populated*

### File List
*To be populated*

## QA Results

*To be populated after implementation*