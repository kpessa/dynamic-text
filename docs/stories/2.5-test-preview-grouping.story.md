# Story 2.5: Test Case Preview Panel and AI-Generated Test Grouping

## Status
Ready for Review

## Story
**As a** content developer working with dynamic sections  
**I want** to see a live preview panel in the test management modal and have tests organized by AI-generated categories  
**So that** I can instantly see test output changes and better organize tests by their purpose (basic functionality, edge cases, QA/breaking)

## Priority
High - Enhances test management workflow and improves test organization

## Acceptance Criteria
1. **Preview Panel Integration**: Split view in modal with test editor on left, live preview on right
2. **Real-time Updates**: Preview updates immediately as test variables or code changes
3. **Test Grouping**: Tests organized into three collapsible groups: "Basic Tests", "Edge Cases", "QA / Breaking"
4. **Group Management**: Can add tests directly to specific groups, move tests between groups
5. **Visual Indicators**: Each group shows count of tests and pass/fail summary
6. **Bulk Operations**: Can run all tests in a group with single action
7. **Import Grouping**: When importing AI-generated tests, preserve their category assignments
8. **Responsive Layout**: Preview panel adapts to different screen sizes
9. **Preview Controls**: Toggle preview panel visibility, adjust split ratio
10. **Group Persistence**: Test group assignments saved with test cases

## Technical Requirements
- Enhance existing TestCaseModal.svelte component
- Integrate previewEngineService for live preview
- Extend test case data structure to include category/group field
- Maintain backward compatibility with existing test cases

## Dev Notes

### Architecture Context

**Component Architecture**
[Source: architecture/6-component-specifications.md#component-communication-pattern]
- Parent-Child communication via props
- Event dispatching for child-to-parent updates
- Service integration for business logic
- Store-based state management where appropriate

**Preview Engine Service**
[Source: src/lib/services/previewEngineService.ts]
- Service provides real-time preview generation
- Handles variable substitution and code execution
- Returns HTML output for rendering
- Already integrated with test runner service

**Test Data Structure Enhancement**
[Source: Current implementation in testRunnerService.ts]
Current structure:
```typescript
interface TestCase {
  name?: string;
  variables?: Record<string, any>;
  expectedOutput?: string;
  expectedStyles?: string;
  matchType?: 'exact' | 'contains' | 'regex';
  testResult?: TestResult;
}
```

Enhanced structure needed:
```typescript
interface TestCase {
  // ... existing fields ...
  category?: 'basicFunctionality' | 'edgeCases' | 'qaBreaking';
}
```

**AI Test Categories**
[Source: api/generate-tests.ts#L229-L240]
- AI generates three categories:
  - `basicFunctionality` - Core functionality tests
  - `edgeCases` - Boundary and edge case tests
  - `qaBreaking` - Security, error handling, breaking tests
- Categories returned as separate arrays in AI response

**Modal Layout Pattern**
[Source: Existing TestCaseModal.svelte implementation]
- Modal uses 90% viewport sizing
- Flexbox layout for content organization
- Tailwind CSS for responsive design
- Dark mode compatibility required

**Component Dependencies**
[Source: Existing component inventory]
- CodeEditor.svelte for code editing
- ValidationStatus.svelte for test results
- previewEngineService for preview generation
- testRunnerService for test execution

### Implementation Architecture

**File Locations**
- Modify: `src/lib/TestCaseModal.svelte` (add preview panel and grouping)
- Update: `src/lib/services/sectionManagementService.ts` (handle category field)
- Update: `src/lib/services/aiTestService.ts` (preserve categories on import)
- No new files needed - enhance existing modal

**State Management**
- Add `testGroups` state to organize tests by category
- Add `showPreview` state for panel visibility
- Add `splitRatio` state for resizable panels
- Derive grouped test counts and pass/fail summaries

**Layout Structure**
```
Modal (90% viewport)
├── Header (title, close button)
├── Main Content (flex row)
│   ├── Left Panel (test editor - flex-1)
│   │   ├── Group Tabs/Accordion
│   │   ├── Test List (per group)
│   │   └── Test Editor Form
│   └── Right Panel (preview - flex-1)
│       ├── Preview Controls
│       └── Preview Content (iframe or div)
└── Footer (save/cancel buttons)
```

**Styling Approach**
- Use CSS Grid or Flexbox for split layout
- Implement resizable divider between panels
- Ensure responsive breakpoints for smaller screens
- Maintain consistent dark mode support

## Tasks / Subtasks

### Task 1: Extend Test Case Data Model (AC: 10)
- [x] Add `category` field to TestCase interface
- [x] Update sectionManagementService to handle category field
- [x] Implement migration for existing tests (default to 'basicFunctionality')
- [x] Unit test data model changes

### Task 2: Implement Test Grouping UI (AC: 3, 4, 5)
- [x] Create collapsible group sections in modal
- [x] Add group headers with test counts
- [x] Implement drag-and-drop or move buttons between groups
- [x] Add visual indicators for pass/fail per group
- [x] Style groups with appropriate icons and colors

### Task 3: Add Preview Panel (AC: 1, 8, 9)
- [x] Split modal layout into two panels
- [x] Add preview container on right side
- [x] Implement resizable divider between panels
- [x] Add preview visibility toggle button
- [x] Ensure responsive behavior on smaller screens

### Task 4: Integrate Live Preview (AC: 2)
- [x] Connect previewEngineService to modal
- [x] Update preview on variable changes (with debouncing)
- [x] Update preview on test selection change
- [x] Handle preview errors gracefully
- [x] Add loading state for preview generation

### Task 5: Implement Bulk Group Operations (AC: 6)
- [x] Add "Run All" button per group
- [x] Implement group-level test execution
- [x] Display group summary results
- [x] Add expand/collapse all groups control

### Task 6: Handle AI Test Import (AC: 7)
- [x] Update aiTestService import logic
- [x] Map AI categories to test groups
- [x] Preserve category assignments on import
- [x] Handle mixed manual and AI-generated tests

### Task 7: Add Group Management Features (AC: 4)
- [x] Implement "Add Test" button per group
- [x] Add context menu for test operations
- [x] Support keyboard shortcuts for group navigation
- [x] Add group-level delete with confirmation

### Task 8: Testing & Polish (AC: All)
- [x] Test with 20+ test cases across groups
- [x] Verify preview updates in real-time
- [x] Test responsive behavior at different breakpoints
- [x] Ensure no regression in existing functionality
- [x] Add proper ARIA labels for accessibility

### Task 9: Documentation
- [x] Update JSDoc comments in TestCaseModal
- [x] Document new data structure changes
- [x] Add usage examples for grouped tests
- [x] Update architecture docs if needed

## Definition of Done
- [ ] All acceptance criteria met
- [ ] Preview panel shows real-time updates
- [ ] Tests properly organized in three groups
- [ ] AI-generated tests maintain category assignments
- [ ] Responsive design works on all screen sizes
- [ ] No regressions in test functionality
- [ ] Code review completed
- [ ] Manual testing passed
- [ ] Unit tests added for new functionality

## Risk Assessment

### Technical Risks
- **Performance Impact**: Live preview might slow down modal with many tests
  - Mitigation: Implement debouncing, virtual scrolling if needed
  
- **Layout Complexity**: Split panel might be difficult on mobile
  - Mitigation: Stack panels vertically on small screens
  
- **Data Migration**: Existing tests need category assignment
  - Mitigation: Default to 'basicFunctionality', allow manual reassignment

### UX Risks
- **Information Overload**: Too much information in modal
  - Mitigation: Collapsible groups, toggle-able preview
  
- **Learning Curve**: New grouping concept for users
  - Mitigation: Clear visual indicators, intuitive drag-and-drop

## Testing Instructions

### Manual Testing
1. Open TestCaseModal for a dynamic section
2. Verify tests are grouped into three categories
3. Add a new test to specific group
4. Move test between groups
5. Edit test variables and see preview update
6. Run all tests in a group
7. Toggle preview panel visibility
8. Resize preview panel
9. Import AI-generated tests and verify grouping
10. Test on mobile viewport

### Automated Testing
- Unit tests for category field handling
- Component tests for grouping logic
- Integration tests for preview updates
- E2E tests for full workflow

## Dependencies
- TestCaseModal.svelte (existing, to be enhanced)
- previewEngineService (existing)
- testRunnerService (existing)
- aiTestService (for import functionality)
- sectionManagementService (for data persistence)

## Handoff Notes
This story enhances the test management modal with two major features: live preview and test grouping. The preview panel provides immediate feedback on test changes, while grouping helps organize tests by their purpose. The implementation should maintain backward compatibility while providing a more powerful testing interface.

## Dev Agent Record

### Agent Model Used
claude-opus-4-1-20250805 (James - Developer Agent)

### Debug Log References
- Successfully extended TestCase interface with category field
- Implemented test grouping UI with collapsible groups
- Added split-view preview panel with live updates
- Integrated previewEngineService for real-time preview
- Updated aiTestService to preserve categories on import

### Completion Notes
- ✅ Extended TestCase data model with category field for grouping
- ✅ Implemented three test groups: Basic Tests, Edge Cases, QA/Breaking
- ✅ Added collapsible group UI with test counts and pass/fail indicators
- ✅ Created split-view layout with live preview panel
- ✅ Integrated real-time preview updates with 500ms debouncing
- ✅ Added bulk operations to run all tests in a group
- ✅ Updated AI import to preserve test categories
- ✅ Implemented responsive design for mobile devices
- ✅ Added ARIA labels for accessibility
- ✅ All tests passing, build successful

### File List
**Modified:**
- src/lib/TestCaseModal.svelte (enhanced with grouping and preview)
- src/lib/services/testRunnerService.ts (added category field)
- src/lib/services/sectionManagementService.ts (updated to handle categories)
- src/lib/services/aiTestService.ts (preserves categories on import)

**Created:**
- tests/services/testRunnerService.test.ts (unit tests for data model)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-31 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-01-31 | 2.0 | Implementation complete | James (Developer) |