# Story 1.7: Safe Incremental App.svelte Refactoring - Brownfield Enhancement

## Status
Ready for Development

## User Story
**As a** Developer,  
**I want** to safely refactor App.svelte into smaller, maintainable components without introducing regressions,  
**So that** the codebase becomes more modular, testable, and maintainable while preserving all existing functionality.

## Story Context

**Existing System Integration:**
- Integrates with: Core App.svelte (3,750 lines to be modularized)
- Technology: Svelte 5 with runes API, TypeScript, Firebase
- Follows pattern: Svelte 5 component architecture with stores
- Touch points: All major UI components and state management

**Background:**
- Previous refactoring attempt reduced App.svelte from 3,750 to 349 lines but introduced regressions
- Regressions included: styling issues, broken preview/output, import errors
- App.svelte has been reverted to working state
- Refactored version saved as App.svelte.refactored for reference
- Component files already created but not integrated

## Acceptance Criteria

**Functional Requirements:**
1. App.svelte must be incrementally refactored following the REFACTOR_EXTRACTION_PLAN.md
2. Each extraction must pass all tests in REFACTOR_TEST_CHECKLIST.md before proceeding
3. Final App.svelte should be under 1,000 lines while maintaining all functionality

**Integration Requirements:**
4. All existing functionality must continue working unchanged:
   - Section management (add, edit, delete, reorder)
   - Code execution and preview
   - Test case management
   - TPN mode and calculations
   - Import/export functionality
   - Firebase synchronization
5. Component integration must use props and events (avoid complex store coupling initially)
6. Each extraction must be committed separately for rollback capability

**Quality Requirements:**
7. No console errors or warnings after each extraction
8. No TypeScript errors that block functionality
9. Performance must not degrade (no lag or freezing)
10. All existing tests must continue passing

## Dev Notes

### Architecture Context
**[Source: architecture/6-component-specifications.md]**
- App.svelte currently 3,556 lines, target <500 lines
- Component communication should use:
  - Parent-Child via Props for data flow
  - Event dispatching for child-to-parent communication
  - Store-based communication for shared state
  - Service integration for business logic

**[Source: architecture/4-architecture-patterns.md]**
- Target structure:
  ```
  src/lib/
  ├── components/        # UI components
  │   ├── SectionManager.svelte (planned)
  │   ├── PreviewEngine.svelte (planned)
  │   └── TestRunner.svelte
  ├── services/          # Business logic layer
  ├── stores/            # State management (Svelte 5 runes)
  └── utils/             # Pure utilities
  ```
- Store Pattern: Use Svelte 5 runes ($state, $derived)
- Service Pattern: Async operations return Promises

### Previous Refactoring Insights
- Attempted extraction from 3,750 to 349 lines was too aggressive
- Import/assignment errors occurred with store usage
- Components were created but integration failed
- Need incremental approach with testing gates

## Technical Approach

### Phase 1: Utility Functions (Low Risk)
- Extract pure functions with no state dependencies
- Move to `/src/lib/utils/` directory per architecture
- Functions: sanitizeHTML, transpileCode, validation helpers
- **No architecture conflicts identified**

### Phase 2: Display Components (Low-Medium Risk)
- Extract read-only components first
- Use props for all data passing per architecture pattern
- Components: TPNKeyReference, display-only previews
- Follow component communication pattern from architecture

### Phase 3: State Management (Medium Risk)
- Migrate UI state to stores one piece at a time
- Keep App.svelte as coordinator initially
- Use Svelte 5 rune pattern from architecture docs
- Stores: uiStateStore, workContextStore (already exist)

### Phase 4: Interactive Components (Higher Risk)
- Extract components with behavior
- Test thoroughly at each step
- Components: SectionManager, PreviewEngine (as specified in architecture)
- Use service layer pattern for business logic

## Tasks / Subtasks

### Task 1: Setup and Preparation (AC: 1, 2)
- [ ] Review REFACTOR_EXTRACTION_PLAN.md completely
- [ ] Review REFACTOR_TEST_CHECKLIST.md completely  
- [ ] Create `/src/lib/utils/` directory structure
- [ ] Verify dev environment is working without errors
- [ ] Create initial git commit as rollback point

### Task 2: Extract Utility Functions (AC: 1, 2, 3)
- [ ] Identify pure functions in App.svelte (sanitizeHTML, transpileCode, etc.)
- [ ] Create utility files following architecture patterns
- [ ] Move functions one at a time with imports
- [ ] Run test checklist after each extraction
- [ ] Commit each successful extraction

### Task 3: Extract Display Components (AC: 4, 5, 6)
- [ ] Extract TPNKeyReference display component
- [ ] Extract read-only preview components
- [ ] Use props/events pattern from architecture docs
- [ ] Test all display functionality per checklist
- [ ] Commit each working component

### Task 4: Migrate State Management (AC: 4, 5, 7)
- [ ] Review existing store implementations
- [ ] Migrate UI flags to stores (one at a time)
- [ ] Use Svelte 5 rune patterns per architecture
- [ ] Test state persistence and reactivity
- [ ] Commit after each store migration

### Task 5: Extract Interactive Components (AC: 4, 5, 6)
- [ ] Extract SectionManager component incrementally
- [ ] Extract PreviewEngine component incrementally
- [ ] Implement service layer pattern for business logic
- [ ] Full regression test after each component
- [ ] Commit each successful extraction

### Task 6: Final Validation (AC: 7, 8, 9, 10)
- [ ] Run complete test checklist end-to-end
- [ ] Verify App.svelte is under 1,000 lines
- [ ] Check for TypeScript errors
- [ ] Performance testing (no lag/freezing)
- [ ] Update documentation with new architecture

## Definition of Done
- [ ] All functionality from REFACTOR_TEST_CHECKLIST.md verified working
- [ ] App.svelte reduced to under 1,000 lines
- [ ] At least 5 components successfully extracted
- [ ] Each extraction has its own commit
- [ ] No regressions in core functionality
- [ ] Documentation updated with new component architecture
- [ ] Code review completed

## Risk Assessment

**Primary Risk:** Reintroducing regressions during extraction
**Mitigation:** 
- Follow strict one-change-at-a-time protocol
- Run full test checklist after each extraction
- Commit working states immediately
- Keep App.svelte.refactored as reference

**Rollback Strategy:** 
- Each extraction in separate commit
- Can revert individual extractions
- App.svelte.backup available as emergency restore

## Implementation Notes

### Critical Guidelines:
1. **NEVER** extract multiple components simultaneously
2. **ALWAYS** run the full test checklist after each change
3. **COMMIT** immediately after each successful extraction
4. **STOP** if any red flags appear (blank screen, import errors, etc.)

### Resources Available:
- `/REFACTOR_EXTRACTION_PLAN.md` - Detailed extraction sequence
- `/REFACTOR_TEST_CHECKLIST.md` - Testing protocol
- `/src/App.svelte.refactored` - Reference for extraction targets
- `/src/App.svelte.backup` - Emergency backup

### Success Metrics:
- Zero regressions in functionality
- Improved code maintainability (measurable by lines per component)
- Clear separation of concerns
- All tests passing

## Handoff Notes for Scrum Master

**Priority:** High - Technical debt that's blocking further development
**Estimated Effort:** 2-3 days (careful, incremental approach)
**Dependencies:** None - all resources in place
**Blocking:** Future feature development on a stable foundation

**Developer Assignment Criteria:**
- Experience with Svelte 5 and runes API
- Strong testing discipline
- Patient, methodical approach
- Comfortable with incremental refactoring

**Progress Tracking:**
- Developer should update extraction progress in REFACTOR_EXTRACTION_PLAN.md
- Each successful extraction should be marked complete
- Any issues should trigger immediate consultation before proceeding