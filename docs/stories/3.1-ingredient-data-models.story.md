# Story 3.1: Create Ingredient Data Models and TypeScript Interfaces

## Status
Ready for Review

## Story
**As a** developer,
**I want** to define the new ingredient and config manifest data structures,
**So that** we have a type-safe foundation for the ingredient-first enhancement

## Acceptance Criteria
1. TypeScript interface for Ingredient entity with sections, tests, and variants
2. TypeScript interface for ConfigManifest that references ingredients  
3. Type definitions for migration and transformation utilities
4. All interfaces properly exported and documented
5. No breaking changes to existing type definitions

## TDD Approach
**Following TDD Agentic Workflow:**
1. **Write Tests First** - Create comprehensive test suite for type guards and validation
2. **Make It Green** - Implement interfaces and type guards to pass tests
3. **Refactor** - Improve type definitions for clarity and maintainability

## Tasks / Subtasks

### Task 0: Write Type Guard Tests FIRST (TDD Step 1)
- [x] Create test file `src/lib/models/__tests__/type-guards.test.ts`
- [x] Write tests for `isIngredient()` type guard:
  ```typescript
  describe('isIngredient type guard', () => {
    it('should return true for valid ingredient', () => {
      const valid = { id: 'calcium', keyname: 'Calcium', sections: [], tests: [] };
      expect(isIngredient(valid)).toBe(true);
    });
    
    it('should return false for missing required fields', () => {
      const invalid = { id: 'calcium' }; // Missing sections
      expect(isIngredient(invalid)).toBe(false);
    });
  });
  ```
- [x] Write tests for `isConfigManifest()` type guard
- [x] Write tests for `isLegacyConfig()` type guard
- [x] Write validation tests for complex nested structures
- [x] Run tests - all should fail initially (Red phase)

### Task 1: Create Core Ingredient Interface (AC: 1)
- [x] Create new file `src/lib/models/ingredient.ts`
- [x] Define `Ingredient` interface with id, keyname, displayName, category fields
- [x] Add `sections: Section[]` property for direct content storage
- [x] Add `tests: TestCase[]` property for test storage
- [x] Define `PopulationVariant` interface for neonatal/pediatric/adult differences
- [x] Add `variants: Map<string, PopulationVariant>` to Ingredient interface
- [x] Add `metadata: IngredientMetadata` interface with timestamps, version, author

### Task 2: Create Config Manifest Interface (AC: 2)
- [x] Create new file `src/lib/models/config.ts`
- [x] Define `ConfigManifest` interface with id, name, source properties
- [x] Define `IngredientReference` interface with ingredientId and optional overrides
- [x] Add `ingredientRefs: IngredientReference[]` array to ConfigManifest
- [x] Define `ConfigSource` interface to track original file/import details
- [x] Add `settings: ConfigSettings` for FLEX-like configuration values

### Task 3: Create Transformation Type Definitions (AC: 3)
- [x] Create new file `src/lib/models/transformations.ts`
- [x] Define `TransformationResult<T>` generic type for transformation operations
- [x] Create `MigrationOptions` interface for migration configuration
- [x] Define `DeduplicationResult` interface for import analysis
- [x] Create `IngredientComparison` interface for similarity detection
- [x] Add type guards: `isIngredient()`, `isConfigManifest()`, `isLegacyConfig()`

### Task 4: Ensure Backward Compatibility (AC: 5)
- [x] Verify existing interfaces in `src/lib/types.ts` (if exists) remain unchanged
- [x] Create type alias if needed: `type LegacyConfig = any` to preserve old signatures
- [x] Ensure new interfaces don't conflict with existing type names
- [x] Add deprecation notices to any interfaces that will be phased out
- [x] Test that TypeScript compilation succeeds with both old and new types

### Task 5: Add Documentation and Exports (AC: 4)
- [x] Add JSDoc comments to all interfaces with examples
- [x] Document the purpose and usage of each property
- [x] Create barrel export in `src/lib/models/index.ts`
- [x] Export all interfaces for use by services and components
- [x] Add README.md in models folder explaining the data model architecture

### Task 6: Create Unit Tests for Type Guards
- [x] Create test file `src/lib/models/__tests__/type-guards.test.ts`
- [x] Test `isIngredient()` with valid and invalid objects
- [x] Test `isConfigManifest()` with various inputs
- [x] Test `isLegacyConfig()` for backward compatibility
- [x] Verify type narrowing works correctly in TypeScript

## Dev Notes

### Architecture Context

**Technology Stack**
[Source: architecture/3-technology-stack.md]
- TypeScript 5.9.2 with strict mode enabled
- Svelte 5.35+ with Runes API
- Firebase Firestore 12.0.0 for persistence
- Build tool: Vite 7.0.4

**File Structure**
[Source: architecture/4-architecture-patterns.md]
New model files should be created in:
```
src/lib/models/          # NEW directory for TypeScript interfaces
├── ingredient.ts        # Ingredient entity interface
├── config.ts           # ConfigManifest interface  
├── transformations.ts  # Transformation utilities
└── index.ts           # Barrel export
```

**Service Layer Pattern**
[Source: architecture/4-architecture-patterns.md#service-layer-pattern]
Interfaces should follow the async Promise pattern:
```typescript
export interface ServiceInterface {
  async operation(): Promise<Result>
  get state(): StateType
  onStateChange(callback: (state) => void): void
}
```

**Existing Type System**
Based on the codebase analysis:
- Current types may be inline or in various service files
- No centralized type definition file found yet
- Need to check for existing `Section` and `TestCase` types to reuse

**Data Model Requirements from PRD**
[Source: docs/ingredient-refactor-brownfield-prd.md]

Ingredient entity structure (from brainstorming):
```javascript
{
  id: "calcium",              // Simple, readable ID
  keyname: "Calcium",         // From KEYNAME in config
  displayName: "Calcium",     // From DISPLAY
  category: "Salt",          // From TYPE
  sections: [...],           // Direct storage!
  tests: [...],              // Direct storage!
  variants: {                // Population-specific
    "neonatal": {...},
    "adult": {...}
  },
  metadata: {...}            // Timestamps, version, etc.
}
```

ConfigManifest structure:
```javascript
{
  id: "choc-pediatric-tpn",
  name: "CHOC Pediatric TPN",
  source: {
    path: "refs/child-build-main-choc.json",
    importedAt: timestamp,
    sha256: "..."
  },
  ingredientRefs: [
    { ingredientId: "calcium", overrides: null },
    { ingredientId: "phosphate", overrides: {...} }
  ],
  settings: {...}  // From FLEX section
}
```

### Testing Standards

[Source: Testing strategy not found in architecture docs - using project conventions]
- Test files should be colocated with source files in `__tests__` directories
- Use Vitest if available (check package.json) or Jest
- Focus on type correctness and type guard functionality
- No specific testing framework mentioned in architecture docs

### Important Notes from Previous Stories

Story 1.7 (Safe Refactoring) is currently in progress and has extracted several services. This new model layer will complement those extractions by providing proper type definitions for the data being managed.

The existing `ingredientExtractionService.ts` already exists and may have some type definitions we can build upon or need to maintain compatibility with.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-31 | 1.0 | Initial story creation from Epic 3 PRD | Bob (SM) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.1 (claude-opus-4-1-20250805)

### Debug Log References
- Test-driven development approach followed strictly
- Created tests first (RED phase), then implementation (GREEN phase)
- All 39 tests passing successfully

### Completion Notes List
- ✅ Followed TDD workflow: Tests → Implementation → Documentation
- ✅ Created comprehensive type guard tests with 39 test cases
- ✅ Implemented all required interfaces with full JSDoc documentation
- ✅ Added backward compatibility layer to avoid breaking existing code
- ✅ Created barrel export for clean imports
- ✅ Added comprehensive README with usage examples
- ✅ All acceptance criteria met

### File List
**Created:**
- `src/lib/models/__tests__/type-guards.test.ts` - Type guard test suite (39 tests)
- `src/lib/models/ingredient.ts` - Ingredient entity interfaces
- `src/lib/models/config.ts` - ConfigManifest interfaces
- `src/lib/models/shared.ts` - Common types (Section, TestCase)
- `src/lib/models/transformations.ts` - Migration utilities and type guards
- `src/lib/models/compatibility.ts` - Backward compatibility aliases
- `src/lib/models/index.ts` - Barrel export
- `src/lib/models/README.md` - Architecture documentation

**Modified:**
- `docs/stories/3.1-ingredient-data-models.story.md` - Updated with completion status

## QA Results

### QA Review Date: 2025-08-31
**Reviewer:** Quinn (QA Test Architect)
**Gate Decision:** ✅ **PASS**

### Test Coverage Analysis
- **Unit Tests:** 39/39 passing (100% pass rate)
- **Type Guards:** Comprehensive coverage for all interfaces
- **Edge Cases:** Properly handled (null, undefined, malformed objects)

### Requirements Traceability
| AC # | Requirement | Implementation | Test Coverage | Status |
|------|-------------|----------------|---------------|--------|
| AC1 | TypeScript interface for Ingredient | ✅ ingredient.ts | 15 tests | PASS |
| AC2 | TypeScript interface for ConfigManifest | ✅ config.ts | 12 tests | PASS |
| AC3 | Type definitions for transformations | ✅ transformations.ts | 12 tests | PASS |
| AC4 | Proper exports and documentation | ✅ index.ts + JSDoc | N/A | PASS |
| AC5 | No breaking changes | ✅ compatibility.ts | Verified | PASS |

### Code Quality Assessment
**Strengths:**
- ✅ Strict TDD approach followed (Red-Green-Refactor)
- ✅ Comprehensive type safety with runtime guards
- ✅ Excellent JSDoc documentation with examples
- ✅ Clean separation of concerns
- ✅ Backward compatibility maintained

**Test Quality:**
- ✅ Tests written before implementation (TDD)
- ✅ Good coverage of happy path and error cases
- ✅ Type narrowing verification
- ✅ Nested structure validation

### Risk Assessment
- **Risk Level:** LOW
- **Technical Debt:** None identified
- **Security Concerns:** None - type definitions only
- **Performance Impact:** Negligible - compile-time only

### Non-Functional Requirements
- **Maintainability:** HIGH - Clear structure, good documentation
- **Testability:** HIGH - Type guards enable runtime validation
- **Scalability:** HIGH - Extensible interface design
- **Type Safety:** EXCELLENT - Full TypeScript coverage

### Recommendations
1. **Future Enhancement:** Consider adding schema validation library (e.g., Zod) for runtime validation beyond type guards
2. **Documentation:** The README.md is comprehensive and helpful

### Gate Decision Rationale
Story 3.1 demonstrates exemplary implementation:
- TDD methodology strictly followed
- All acceptance criteria met
- 100% test pass rate
- No technical debt introduced
- Sets strong foundation for subsequent stories

**Quality Score: 95/100**