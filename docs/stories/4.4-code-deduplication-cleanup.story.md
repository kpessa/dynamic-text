# Story 4.4: Code Deduplication & Architecture Cleanup

## Status
Ready for Development

## Story
**As a** development team,
**I want** a clean, maintainable codebase with the ingredient-first architecture as the standard,
**so that** we can reduce technical debt, improve maintainability, and eliminate confusion from duplicate code paths.

## Acceptance Criteria
1. Legacy section-based code paths are identified and removed
2. Duplicate services and components are consolidated
3. All code follows the ingredient-first architecture pattern
4. Code reduction of at least 30% is achieved
5. All functionality remains intact after cleanup
6. Code quality metrics improve (complexity, maintainability)
7. Documentation is updated to reflect new architecture

## Tasks / Subtasks

### TDD Workflow (MANDATORY - Follow this exact order)
**Phase 1: Write Tests First**
- [ ] Write tests for ingredient-first data model operations
- [ ] Write tests for consolidated service interfaces
- [ ] Write tests verifying no section-based code remains
- [ ] Write tests for code metrics (complexity, size)
- [ ] Write integration tests for refactored components
- [ ] Write E2E tests for all user workflows
- [ ] Write regression tests for critical paths

**Phase 2: Make Tests Pass (Minimal Implementation)**
- [ ] Identify and Document Duplications (AC: 1, 2)
  - [ ] Audit src/App.svelte for duplicate logic
  - [ ] Identify legacy section management code
  - [ ] Find duplicate Firebase service implementations
  - [ ] Document overlapping component functionality
  - [ ] Create deprecation list with migration paths
  - [ ] ✅ Verify duplication audit tests pass

- [ ] Remove Legacy Section-Based Code (AC: 1, 3)
  - [ ] Remove old section store if separate from ingredient model
  - [ ] Delete legacy section components
  - [ ] Remove section-based Firebase queries
  - [ ] Update imports to use ingredient-first modules
  - [ ] Clean up unused section-related utilities
  - [ ] ✅ Verify no section-based code tests pass

- [ ] Consolidate Service Layer (AC: 2, 3)
  - [ ] Merge duplicate Firebase service functions
  - [ ] Consolidate ingredient and section services
  - [ ] Unify data transformation logic
  - [ ] Remove redundant API calls
  - [ ] Standardize service interfaces
  - [ ] ✅ Verify service consolidation tests pass

- [ ] Refactor Components to Ingredient-First (AC: 3, 5)
  - [ ] Update components to use ingredient data model
  - [ ] Remove section-based props and events
  - [ ] Standardize component communication patterns
  - [ ] Update state management to ingredient stores
  - [ ] Ensure backward compatibility during transition
  - [ ] ✅ Verify component refactor tests pass

- [ ] Clean Up Utilities and Helpers (AC: 2, 4)
  - [ ] Remove duplicate utility functions
  - [ ] Consolidate similar helper modules
  - [ ] Delete unused imports and exports
  - [ ] Optimize bundle size
  - [ ] Update util function signatures
  - [ ] ✅ Verify utility cleanup tests pass

- [ ] Measure and Validate Code Reduction (AC: 4, 6)
  - [ ] Run code metrics before cleanup
  - [ ] Track lines of code removed
  - [ ] Measure cyclomatic complexity reduction
  - [ ] Verify bundle size improvements
  - [ ] Document performance improvements
  - [ ] ✅ Verify 30% code reduction achieved

**Phase 3: Refactor for Maintainability**
- [ ] Break down App.svelte into smaller components (max 300 lines each)
  - [ ] Extract header into AppHeader.svelte
  - [ ] Extract editor section into EditorWorkspace.svelte
  - [ ] Extract preview section into PreviewWorkspace.svelte
  - [ ] Extract status bar into StatusBar.svelte
  - [ ] Create AppOrchestrator for coordination (max 200 lines)
- [ ] Consolidate services into clean architecture
  - [ ] Create single IngredientService (max 400 lines)
  - [ ] Create unified DataService interface (max 300 lines)
  - [ ] Extract business logic from components
- [ ] Organize utilities into logical modules
  - [ ] Create ValidationUtils module (max 200 lines)
  - [ ] Create FormatUtils module (max 200 lines)
  - [ ] Create DOMUtils module (max 150 lines)
- [ ] ✅ Verify ALL tests still pass after refactoring
- [ ] ✅ Ensure App.svelte is under 500 lines
- [ ] ✅ Ensure no component exceeds 300 lines
- [ ] ✅ Maintain all functionality after refactoring
- [ ] ✅ Achieve minimum 80% test coverage

- [ ] Update Documentation (AC: 7)
  - [ ] Update architecture documentation
  - [ ] Remove references to legacy patterns
  - [ ] Create migration guide for remaining code
  - [ ] Update component documentation
  - [ ] Update README with new patterns

- [ ] Comprehensive Testing (AC: 5)
  - [ ] Run full test suite after each major removal
  - [ ] Verify all user workflows still function
  - [ ] Test data migration paths
  - [ ] Perform regression testing
  - [ ] Update tests to match new architecture

## Dev Notes

### Current Architecture Issues
[User reported]: "trying to take all the changes I made with the ingredient first and make that the standard, slowly removing the other stuff, making the app more clean and trying to take out all duplications"

### Identified Duplication Areas
[Source: architecture-shards/4-architecture-patterns.md#Component Architecture]
- App.svelte is marked as "needs refactoring" - likely contains mixed patterns
- Both section-based and ingredient-based data models exist
- Multiple Firebase service implementations

### Target Architecture
[Source: architecture-shards/4-architecture-patterns.md#Service Layer Pattern]
```
src/
├── lib/
│   ├── components/        # Ingredient-first components only
│   ├── services/          # Unified service layer
│   │   ├── ingredientService.ts (primary)
│   │   └── firebaseService.ts (data layer)
│   ├── stores/            # Ingredient-based stores
│   │   └── ingredientStore.svelte.ts
│   └── utils/             # Cleaned utilities
```

### Refactoring Strategy
1. Start with non-critical paths to minimize risk
2. Use feature flags if needed for gradual rollout
3. Maintain backward compatibility until full migration
4. Delete code only after confirming no dependencies

### Code Quality Targets
- Reduce App.svelte from current size to under 500 lines
- Achieve 30%+ overall code reduction
- Improve maintainability index by 20%
- Reduce cyclomatic complexity in key components

### State Management Pattern
[Source: architecture-shards/4-architecture-patterns.md#State Management]
Use Svelte 5 runes consistently:
- $state for reactive state
- $derived for computed values
- $effect for side effects
- Remove any legacy store patterns

## Testing
[Source: architecture-shards/3-technology-stack.md#Development Tools]
- Unit tests for all modified services
- Integration tests for data flow
- E2E tests for critical user journeys
- Performance benchmarks before/after
- Code quality metrics with ESLint

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-01 | 1.0 | Initial story creation | Scrum Master Bob |

## Dev Agent Record
### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

## QA Results
_To be filled by QA agent_